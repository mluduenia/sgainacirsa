<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:sec="http://www.springframework.org/security/tags"
	xmlns:f="http://java.sun.com/jsf/core" xmlns:p="http://primefaces.org/ui">

<h:body>

	<ui:composition template="../template/template.xhtml">


		<ui:define name="content">





			<!-- nuevo -->
			<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdR06M2wq1XRh73M-egCkmnuD3Vzw91SU" type="text/javascript"></script>

			<!-- viejo 
			<script src="https://maps.google.com/maps/api/js?key=AIzaSyA7ZKV8MMQrPXgbDJerCLWG1_NhnFDqGd0&amp;v=3"></script>-->
			<h:form id="frmMapa">

				<p:messages id="messages" showDetail="true" />

				<p:poll id="poll_update" interval="300" listener="#{mapsLoaderMB.reset}" oncomplete="reloadMaps()" update="stringDate" global="false" />

				<p:panelGrid id="panelFecha" columns="1" style="width: 100%;text-align: right;font-size: 14px;">
					<h:panelGroup>
						<h:outputLabel value="#{messages.fecha_hora_refresh}:" />
						<h:inputText id="stringDate" readonly="true" value="#{mapsLoaderMB.refreshDate}" style="width: 150px;">
							<f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
						</h:inputText>
						<h:outputLabel value="(#{messages.mensaje_pagina_actualizada5})" style="width: 100%;" />
					</h:panelGroup>
				</p:panelGrid>
				
				<p:fieldset legend="#{messages.mapas_amenazas}">

					<p:panelGrid columns="1" style="width: 100%; ">
						<p:selectOneRadio widgetVar="wvLayers" id="sorLayer" value="#{mapsLoaderMB.selectedLayer}" onchange="reloadMaps();" style="width: 100%">
							<f:selectItem itemValue="amenazas" itemLabel="#{messages.niveles_amenaza}" />
							<f:selectItem itemValue="24" itemLabel="#{messages.lluvias_ultimas_24_short}" />
							<f:selectItem itemValue="12" itemLabel="#{messages.lluvias_ultimas_12_short}" />
							<f:selectItem itemValue="6" itemLabel="#{messages.lluvias_ultimas_6_short}" />
							<f:selectItem itemValue="3" itemLabel="#{messages.lluvias_ultimas_3_short}" />
							<f:selectItem itemValue="1" itemLabel="#{messages.lluvias_ultimas_1_short}" />
							<f:selectItem itemValue="sgaViewEstacionesIconos" itemLabel="#{messages.estaciones}" />
						</p:selectOneRadio>
					</p:panelGrid>



					<p:panelGrid columns="1" style="width: 100%; text-align:left; font-size: 14px">
						<h:panelGroup>
							<h:graphicImage rendered="true" value="../images/SD_ICON.png" height="20px" />
							<h:outputLabel value="#{messages.su_geolocalizacion}" />
							<div id="info" style="display: none; font-family: Arial, sans-serif; font-size: 14px;"></div>
						</h:panelGroup>
					</p:panelGrid>


					<!-- MAP -->
					<div style="width: 100%">
						<div id="map" class="map" style="height: 900px">
							<div id="gmap" class="fill"></div>
							<div id="olmap" class="fill"></div>
						</div>

						<div id="wrapper">
							<div id="scale" class="escala"></div>
						</div>
					</div>



					<ui:include src="/leyendas3.xhtml" />


					<p:spacer height="10" />

					<p:panelGrid id="pDisclaimer" columns="1" style="width: 100%">
						
						<h:outputText value="#{messages.disclaimer}" escape="false" />
					</p:panelGrid>
					
					<p:panelGrid columns="1" style="width: 100%; text-align:right">
							<h:graphicImage rendered="true" value="/images/logo.png" />
						</p:panelGrid>

				</p:fieldset>
			</h:form>

			<script src="ol.js"></script>
			<script src="mapas.js" type="text/javascript"></script>


			<script type="text/javascript">
				//<![CDATA[
				/* Poll reload and layers switch*/
				function reloadMaps() {

					var layerSelected = PF('wvLayers').getJQ().find(':checked').val();
					var viewparams = [ 'p_force_refresh:' + Date.now() ];

					if (layerSelected == 'amenazas') {
						// mapa por defecto: capas cuencas-estaciones-drenaje						
						sourceEstaciones = new ol.source.ImageWMS({
							ratio : 1,
							url : wmsLocation,
							params : {
								'FORMAT' : format,
								'VERSION' : '1.1.1',
								viewparams : viewparams,
								LAYERS : 'wspCirsa:sgaViewEstaciones',
								STYLES : ''
							}
						})
						sourceCuencas = new ol.source.ImageWMS({
							ratio : 1,
							url : wmsLocation,
							params : {
								'FORMAT' : format,
								'VERSION' : '1.1.1',
								viewparams : viewparams,
								LAYERS : 'wspCirsa:sgaViewAlertasCuencas',
								STYLES : '',
							}
						})

						estacionesLayer.setSource(sourceEstaciones);
						cuencasLayer.setSource(sourceCuencas);

					} else if (layerSelected == 'sgaViewEstacionesIconos') {
						cuencasLayer.setSource(null);

						// capas estaciones info -drenaje
						var sourceEstacionesIconos = new ol.source.ImageWMS({
							ratio : 1,
							url : wmsLocation,
							params : {
								'FORMAT' : format,
								viewparams : viewparams,
								'VERSION' : '1.1.1',
								LAYERS : 'sgaViewEstacionesIconos',
								STYLES : '',
							}
						});
						estacionesLayer.setSource(sourceEstacionesIconos);

					} else {
						cuencasLayer.setSource(null);

						// capas lluvia-drenaje
						var sourceLLuvia = new ol.source.ImageWMS({
							ratio : 1,
							url : wmsLocation,
							params : {
								'FORMAT' : format,
								viewparams : 'p_ventana:' + layerSelected,
								'VERSION' : '1.1.1',
								LAYERS : 'wspCirsa:sgaViewDWData24h',
								STYLES : '',
							}
						});
						estacionesLayer.setSource(sourceLLuvia);

					}
					// para todos los casos recargar la capa de drenaje
					sourceDrenaje = new ol.source.ImageWMS({
						ratio : 1,
						url : wmsLocation,
						params : {
							'FORMAT' : format,
							'VERSION' : '1.1.1',
							viewparams : viewparams,
							LAYERS : 'wspCirsa:sgaViewSADrenaje',
							STYLES : '',
						}
					});
					drenajeLayer.setSource(sourceDrenaje);
				}

				//]]>
			</script>


		</ui:define>
	</ui:composition>

</h:body>

</html>